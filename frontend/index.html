<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLVM Obfuscator Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #0f1724;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent-1: #7dd3fc;
      --accent-2: #c4b5fd;
      --glass: rgba(255,255,255,0.04);
      --surface: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --success: #10b981;
      --danger: #ef4444;
      --radius: 14px;
      color-scheme: dark;
    }

    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent 8%),
                  radial-gradient(700px 400px at 90% 90%, rgba(14,165,233,0.06), transparent 6%),
                  var(--bg-1);
      color: #e6eef8;
      padding:18px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex;align-items:stretch;justify-content:center;
    }

    .frame{
      width:100%;height:calc(100vh - 36px);border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(2,6,23,0.7);
      border:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;flex-direction:column;
    }

    /* Header */
    header{
      display:flex;align-items:center;justify-content:space-between;padding:20px 28px;background:linear-gradient(90deg,var(--card), rgba(11,18,32,0.86));
      flex:0 0 auto;
    }
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#052033;font-size:18px;box-shadow:0 6px 18px rgba(124,58,237,0.12)}
    .brand h1{font-size:1.05rem;font-weight:700}
    .brand p{font-size:0.82rem;color:var(--muted);margin-top:2px}

    /* content columns */
    .content{display:grid;grid-template-columns:420px 1fr;gap:20px;padding:22px;align-items:start;flex:1 1 auto;overflow:hidden}

    /* Left - Upload + techniques */
    .left-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:100%;overflow:auto}
    .section-title{font-weight:700;font-size:1rem;margin-bottom:10px;color:#e9f2ff;display:flex;align-items:center;gap:10px}
    .helper{font-size:0.85rem;color:var(--muted);margin-bottom:12px}

    /* custom file input */
    .file-drop{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));border:1px dashed rgba(255,255,255,0.04);display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .12s ease}
    .file-drop:hover{transform:translateY(-4px)}
    .file-input{opacity:0;position:absolute;pointer-events:none}
    .file-meta{display:flex;flex-direction:column}
    .file-meta .name{font-weight:700}
    .file-meta .sub{font-size:0.82rem;color:var(--muted)}
    .file-icon{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-weight:700}

    /* techniques grid */
    .techniques-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .tech-card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;gap:12px;align-items:flex-start;transition:all .12s ease}
    .tech-card:hover{transform:translateY(-6px)}
    .tech-card.selected{border-color:rgba(124,58,237,0.9);background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(125,211,252,0.03))}

    .tech-check{min-width:36px;min-height:36px;border-radius:8px;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700}
    .tech-check.checked{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#02131a;border-color:transparent}
    .tech-info .name{font-weight:800}
    .tech-info .desc{font-size:0.86rem;color:var(--muted);margin-top:6px;line-height:1.3}

    /* right side - results */
    .right-card{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px;height:100%;overflow:auto}
    .status{padding:12px;border-radius:10px;font-weight:700;background:linear-gradient(90deg,#052033,rgba(124,58,237,0.12));color:#e6f9ff}
    .metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .metric{padding:14px;border-radius:10px;background:rgba(255,255,255,0.02);border-left:4px solid rgba(124,58,237,0.75)}
    .metric .label{font-size:0.9rem;color:var(--muted)}
    .metric .value{font-weight:800;font-size:1.4rem;margin-top:6px;color:var(--accent-2)}

    .applied-techs{display:flex;flex-wrap:wrap;gap:8px}
    .badge{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

    .download-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .download-btn{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#041022;text-decoration:none;font-weight:700;border:0;display:inline-flex;align-items:center;gap:10px}
    .download-btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .download-btn:focus{outline:2px solid rgba(255,255,255,0.06)}

    .action-row{display:flex;gap:12px;align-items:center;margin-top:6px}
    .primary{background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#041022;padding:12px 16px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .primary:disabled{opacity:0.5;cursor:not-allowed}
    .new-file-btn{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:var(--muted)}

    .loading{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);border-top-color:transparent;animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{padding:12px 18px;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:0.85rem;flex:0 0 auto}

    /* responsive */
    @media (max-width:1100px){
      .content{grid-template-columns:1fr;gap:14px;padding:16px}
      .left-card{order:1}
      .right-card{order:2}
      header{padding:14px}
    }

    /* ensure desktop buttons visible */
    @media (min-width:1101px){
      .content{padding:28px}
      .download-btn{min-width:140px}
      .primary{min-width:180px}
    }
  </style>
</head>
<body>
  <div class="frame" id="app">
    <header>
      <div class="brand">
        <div class="logo">LO</div>
        <div>
          <h1>LLVM Obfuscator Pro</h1>
          <p>Advanced code protection ‚Äî lightweight & production-ready</p>
        </div>
      </div>
      <!-- removed local API/mode pills per request -->
      <div style="color:var(--muted);font-size:0.9rem">Ready</div>
    </header>

    <div class="content">
      <!-- LEFT -->
      <section class="left-card" aria-labelledby="uploadHeading">
        <div>
          <div class="section-title">üìÅ Upload Source</div>
          <div class="helper">Drag & drop or click to select a C/C++ file. Supported: <code>.c</code>, <code>.cpp</code></div>

          <label class="file-drop" for="sourceFile">
            <input class="file-input" id="sourceFile" type="file" accept=".c,.cpp" />
            <div class="file-icon">C</div>
            <div class="file-meta">
              <div class="name">No file selected</div>
              <div class="sub">Max size: 5MB ‚Ä¢ Single file</div>
            </div>
          </label>
        </div>

        <div style="margin-top:16px">
          <div class="section-title">‚öôÔ∏è Obfuscation Techniques</div>
          <div class="helper">Select one or more techniques. Click a card to toggle.</div>

          <div class="techniques-grid" id="techniquesGrid"></div>

          <div class="action-row" style="margin-top:16px">
            <button id="obfuscateBtn" class="primary" disabled>
              <span class="btn-text">üöÄ Start Obfuscation</span>
              <span class="loading" style="display:none;margin-left:8px"></span>
            </button>
            <button id="newFileBtn" class="new-file-btn" title="Reset form">üìÅ New File</button>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="right-card" aria-labelledby="resultsHeading">
        <div id="resultsSection" style="display:block">
          <div id="statusMessage" class="status">Obfuscation status will appear here</div>

          <div class="section-title" style="margin-top:6px">üìä Obfuscation Report</div>

          <div class="metrics" id="metricsGrid">
            <div class="metric">
              <div class="label">Techniques Applied</div>
              <div class="value">0</div>
            </div>
            <div class="metric">
              <div class="label">Strings Encrypted</div>
              <div class="value">0</div>
            </div>
            <div class="metric">
              <div class="label">Functions Renamed</div>
              <div class="value">0</div>
            </div>
            <div class="metric">
              <div class="label">Bogus Instructions</div>
              <div class="value">0</div>
            </div>
          </div>

          <div class="section-title" style="margin-top:10px">üîß Applied Techniques</div>
          <div class="applied-techs" id="appliedTechniques"><span class="badge">‚Äî</span></div>

          <div class="download-row" style="margin-top:12px">
            <a id="downloadExe" class="download-btn" href="#">‚¨áÔ∏è EXE</a>
            <a id="downloadLL" class="download-btn secondary" href="#">‚¨áÔ∏è LLVM IR</a>
            <a id="downloadReport" class="download-btn secondary" href="#">üìä Report</a>
            <button class="download-btn" onclick="generatePDF()">üìÑ PDF Report</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>Built with ‚ù§Ô∏è ¬∑ Local-first workflow</div>
      <div>v1.2 ‚Ä¢ ¬© LLVM Obfuscator</div>
    </footer>
  </div>

  <script>
    // keep original behavior & element IDs so existing backend stays compatible
    const techniques = [
      { id: 'stringenc', name: 'String Encryption', description: 'Encrypts all string literals and decrypts them at runtime.' },
      { id: 'bogus-instructions', name: 'Bogus Instructions', description: 'Inserts dead instructions & opaque code to confuse analysis.' },
      { id: 'rename-symbols', name: 'Symbol Renaming', description: 'Renames functions and variables to meaningless identifiers.' },
      { id: 'dynamic-xor', name: 'Dynamic XOR', description: 'Applies XOR masks with dynamic runtime keys.' },
      { id: 'cfflatten', name: 'Control Flow Flattening', description: 'Flattens branches and hides actual control flow.' },
      { id: 'opaque-preds', name: 'Opaque Predicates', description: 'Injects always-true/false predicates to mislead analyzers.' },
      { id: 'bbsplit', name: 'Basic Block Splitting', description: 'Splits basic blocks into multiple smaller pieces.' },
      { id: 'anti-debug', name: 'Anti-Debugging', description: 'Adds runtime checks to detect and disrupt debuggers.' }
    ];

    function initializeTechniques(){
      const grid = document.getElementById('techniquesGrid');
      techniques.forEach(t => {
        const el = document.createElement('div');
        el.className = 'tech-card';
        el.innerHTML = `
          <div class="tech-check" data-tech="${t.id}"></div>
          <div class="tech-info">
            <div class="name">${t.name}</div>
            <div class="desc">${t.description}</div>
          </div>
        `;

        el.addEventListener('click', () => {
          const check = el.querySelector('.tech-check');
          check.classList.toggle('checked');
          el.classList.toggle('selected');
          updateObfuscateButton();
        });

        grid.appendChild(el);
      });
    }

    function updateObfuscateButton(){
      const fileInput = document.getElementById('sourceFile');
      const obfuscateBtn = document.getElementById('obfuscateBtn');
      const hasFile = fileInput.files.length > 0;
      const hasTechniques = document.querySelectorAll('.tech-check.checked').length > 0;
      obfuscateBtn.disabled = !(hasFile && hasTechniques);
    }

    // reflect file name in the UI
    const fileLabelName = document.querySelector('.file-meta .name');
    const fileInputEl = document.getElementById('sourceFile');
    fileInputEl.addEventListener('change', (e) => {
      if (fileInputEl.files.length){
        fileLabelName.textContent = fileInputEl.files[0].name;
      } else {
        fileLabelName.textContent = 'No file selected';
      }
      updateObfuscateButton();
    });

    // original obfuscation flow (preserved)
    document.getElementById('obfuscateBtn').addEventListener('click', async function(){
      const fileInput = document.getElementById('sourceFile');
      const obfuscateBtn = this;
      const btnText = obfuscateBtn.querySelector('.btn-text');
      const spinner = obfuscateBtn.querySelector('.loading');
      const resultsSection = document.getElementById('resultsSection');
      const statusMessage = document.getElementById('statusMessage');

      if (!fileInput.files.length){ alert('Please select a source file'); return; }

      // selected techniques -- note: class names preserved for compatibility
      const selectedTechniques = Array.from(document.querySelectorAll('.tech-check.checked')).map(c => c.getAttribute('data-tech'));
      if (!selectedTechniques.length){ alert('Please select at least one obfuscation technique'); return; }

      obfuscateBtn.disabled = true; btnText.textContent = 'Processing...'; spinner.style.display = 'inline-block';
      statusMessage.className = 'status'; statusMessage.style.background = 'linear-gradient(90deg,#052033,rgba(124,58,237,0.12))'; statusMessage.textContent = 'Obfuscation in progress...';

      try {
        const formData = new FormData();
        formData.append('uploaded_file', fileInput.files[0]);
        formData.append('techniques', JSON.stringify(selectedTechniques));

        const response = await fetch('http://127.0.0.1:8000/obfuscate', { method:'POST', body: formData });
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        statusMessage.className = 'status'; statusMessage.style.background = 'linear-gradient(90deg,#052033,rgba(16,185,129,0.06))'; statusMessage.textContent = '‚úÖ Obfuscation completed successfully!';
        displayResults(data, selectedTechniques);
      } catch(err){
        statusMessage.className = 'status'; statusMessage.style.background = 'linear-gradient(90deg,#fff1f2, #fee2e2)'; statusMessage.textContent = '‚ùå Error: ' + err.message;
        console.error('Obfuscation failed:', err);
      } finally {
        obfuscateBtn.disabled = false; btnText.textContent = 'üöÄ Start Obfuscation'; spinner.style.display = 'none';
      }
    });

    function displayResults(data, selectedTechniques){
      const metricsGrid = document.getElementById('metricsGrid');
      const appliedTechniques = document.getElementById('appliedTechniques');
      const downloadExe = document.getElementById('downloadExe');
      const downloadLL = document.getElementById('downloadLL');
      const downloadReport = document.getElementById('downloadReport');

      const metrics = data.metrics || {};
      metricsGrid.innerHTML = `
        <div class="metric"><div class="label">Techniques Applied</div><div class="value">${selectedTechniques.length}</div></div>
        <div class="metric"><div class="label">Strings Encrypted</div><div class="value">${metrics.strings_encrypted || 0}</div></div>
        <div class="metric"><div class="label">Functions Renamed</div><div class="value">${metrics.functions_renamed || 0}</div></div>
        <div class="metric"><div class="label">Bogus Instructions</div><div class="value">${metrics.bogus_instr_count || 0}</div></div>
      `;

      appliedTechniques.innerHTML = selectedTechniques.map(id => { const t = techniques.find(x=>x.id===id); return `<span class="badge">${t? t.name : id}</span>`; }).join('');

      if (data.exe) downloadExe.href = `http://127.0.0.1:8000/download?path=${encodeURIComponent(data.exe)}`;
      if (data.ll) downloadLL.href = `http://127.0.0.1:8000/download?path=${encodeURIComponent(data.ll)}`;
      if (data.report) downloadReport.href = `http://127.0.0.1:8000/download?path=${encodeURIComponent(data.report)}`;
    }

    document.getElementById('newFileBtn').addEventListener('click', function(){
      const fileInput = document.getElementById('sourceFile');
      fileInput.value = '';
      document.querySelectorAll('.tech-check.checked').forEach(c=>c.classList.remove('checked'));
      document.querySelectorAll('.tech-card.selected').forEach(c=>c.classList.remove('selected'));
      document.querySelector('.file-meta .name').textContent = 'No file selected';
      updateObfuscateButton();
    });

    async function generatePDF(){
      try{
        const response = await fetch('http://localhost:8000/generate-pdf');
        const result = await response.json();
        if (result.success) window.open(`http://localhost:8000/download?path=${encodeURIComponent(result.pdf_path)}`);
        else alert('Failed to generate PDF');
      } catch(e){console.error(e); alert('Error generating PDF report');}
    }

    // init
    initializeTechniques();
  </script>
</body>
</html>
